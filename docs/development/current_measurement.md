# Current measurement

Energy-consumption monitoring is more important due to the trend toward smaller-sized electronic systems with increased functionality. Picking the correct method to monitor current for a given application is important in optimizing system performance.

## Measurement principle

There are various techniques for current measurement, which can be broadly classified into direct and indirect methods. The direct method makes use of **Ohm's law** where as indirect method is based on **Maxwell's equations**. Most popular current measurement techniques are discussed below.

### 1. Shunt resistor

A shunt is a low value resistor ($R_s$) used in current measurement. It is generally connected in series to the branch in which current is to be measured as shown in Fig. 1. Using Ohm's law, the current through the branch of interest can be calculated by measuring the voltage across the shunt resistor. For example, if $V_s$ is the measured voltage across the shunt of value $R_s$, then current is given by

$$I_s = \frac{V_s}{R_s}$$

In order to minimize the power loss and heat dissipation in the circuit, shunts must have very low value of resistance (in the range of milli ohms). But this comes with the downside of low voltage drop across the shunt. Hence, according to the requirement, care must be taken in choosing the appropriate value of resistance for the shunt.

<fig-caption src="development/shunt_current_measurement.svg" caption="Principle of shunt based current measurement" num="1" />

To overcome the issue of low voltage drop across the shunt, a voltage amplifier (current sense amplifier) can be used to increase this small voltage drop to an appropriate range. This voltage amplifier is used in differential configuration in order to measure the voltage difference between its two terminals as shown in Fig. 2. The gain depends on the resistors **$R_3/R_1$** and **$R_4/R_2$**. Further, the output from the current sense amplifier can be applied to Analog to Digital Converter (ADC) or other intermediate circuit to obtain the value of current of interest.

<fig-caption src="development/shunt_amplifier.svg" caption="Shunt with current sense amplifier" num="2" />

In the above circuit, the resistor pairs $R_1$-$R_2$ and $R_3$-$R_4$ have to be matched. i.e, $R_1$ = $R_2$ and $R_3$ = $R_4$. In this case, the output voltage $V_{out}$ is given by

$$V_{out} = Gain \cdot V_{s}$$

where $Gain = \frac{R_4}{R_2}$ and $V_{s} = I_{s} \cdot R_{s}$

The circuit shown in Fig. 2 can measure only uni-directional current. In order to measure bi-directional current of same magnitude, the resistor $R_3$ has to be connected to a reference voltage (mid supply voltage) as shown in Fig. 3. The required reference voltage can be generated in various ways like - using Zener diode, voltage source with voltage follower Opamp, DAC from micro-controller and many more methods which vary according to the user requirements. In the following case, $V_{out}$ is given by

$$V_{out} = Gain \cdot V_{s} + V_{ref}$$

<fig-caption src="development/shunt_amplifier_bidirectional.svg" caption="Shunt with bi-directional current sense amplifier" num="3" />

### 2. Hall effect sensor

Hall effect current measurement is a non-contact method based on the principle that for a given current flow, a proportional magnetic field is produced around the current-carrying conductor. In a [Hall sensor](https://en.wikipedia.org/wiki/Hall_effect_sensor), the current carrying conductor passes through a magnetically permeable core. The Hall effect device is mounted perpendicular to the magnetic field generated by current-carrying conductor. This produces a potential difference (voltage) that can be measured.

When a hall sensor (component with X mark) like [ACS712](https://www.sparkfun.com/datasheets/BreakoutBoards/0712.pdf) is connected to the branch carrying the current of interest, due to the above principle, a voltage difference is generated at the two output terminals of the sensor. The generated voltage potential is linearly proportional to the current passing through the hall sensor. Depending on the requirement, if the generated voltage potential is found to be small, an amplifier of appropriate gain can be used to increase the magnitude as shown in the Fig. 4. This method provides isolation from the main circuit unlike shunt based method. In addition to that, it also decreases the heat dissipation. Since sensitive components are used, implementation of hall sensor based current measurement is more expensive than the former method.

<fig-caption src="development/hall_current_measurement.svg" caption="Principle of hall sensor based current measurement" num="4" />

### 3. Inductive sensor

The [inductive sensor](https://en.wikipedia.org/wiki/Inductive_sensor) consists of a wire-wound core through which current carrying conductor passess. AC current flowing through this conductor constantly changes potential from positive to negative and back again. This results in expanding and collapsing magnetic field which induces voltage in the windings. Further inductive sensor converts this induced voltage into proportional voltage which will be given as output. Hence, in this case, voltage is the measure of change in magnetic field strength and not direct measure of magnetic field as in the case of Hall effect sensor. That's why inductive sensors are only suitable for measuring AC currents over other methods. Like Hall sensor, this also provides excellent isolation from the main circuit and has the advantage of very low noise when compared with the former.

### Conclusion

The different methods of current measurement are compared in the table below. Although on a quick look shunt based method looks more promising and efficient than other methods, it is generally preferable for small and medium voltages or currents considering the power-dissipation problem. But due to its very good linearity, it is also used in high current systems, depending on the application. For applications which involve high voltage or current ratings or need good isolation from the main circuit, Hall sensor or inductive sensor methods are usually preferred. Also, when AC current is involved, inductive sensor is often a good choice. Hence suitable method must be chosen according to the requirement of the system.

| Parameter        | Shunt resistor  | Hall sensor   |Inductive sensor|
|:----------------:|:---------------:|:-------------:|:------------:  |
| Complexity       | Low             | High          | Medium         |
| Cost             | Low             | High          | High           |
| Accuracy         | High            | Medium        | Medium         |
| Power dissipation| High            | Low           | Low            |
| Noise            | Low             | High          | Medium         |
| Isolation        | No              | Yes           | Yes            |

## Positioning of sensor

In the shunt based current measurement technique as used in many DC energy system, the position of the shunt can be of importance depending on the application. Based on it's position, it can be classified into low-side and high-side current measurement technique. Although both of these configurations work almost in a same manner, each have their own merits and demerits.

### 1. Low-side current measurement.

In this configuration, the shunt is placed between the load and the ground as shown in Fig. 5.

<fig-caption src="development/low_side_current_measurement.svg" caption="Principle of low-side current measurement" num="5" />

The common mode voltage for the amplifier is referenced to ground and hence any cheap and readily available voltage amplifier can be used. But this configuration also has a major disadvantage of ground loop issues. Since the shunt is connected between load and ground, the load may not be at exact same ground potential as the rest of the circuit. Another major disadvantage of the low-side configuration is the ground loop problem which might result is measurement errors in the case of automobile applications. But this problem is usually not encountered in applications like DC energy systems.

An amplifier can be connected in either single ended or differential configuration. Single ended configuration is shown in Fig. 6a and requires least components and is very simple. But in designs having low value sense resistors or high ground current, it suffers from low accuracy issues. Differential configuration as shown in Fig. 6b make use of classic differential amplifier that senses the voltage drop directly across the shunt and hence provides better accuracy than the former.

<fig-caption src="development/low_side_amplifier.svg" caption="Low-side current measurement using (a) Singled ended and (b) Differential configuration" num="6" />

### 2. High-side current measurement.

In this configuration, the shunt is placed between the supply voltage and the load as shown in Fig. 7. This helps to eliminate ground disturbances which was a hurdle in low-side measurement technique and also helps in detecting accidental shorts to system ground. In spite of having this advantage, it suffers from the problem of high common mode voltage. Hence the amplifier used to amplify the small voltage drop across the shunt needs to have specification such that it can tolerate high common-mode voltage (close to supply voltage). This poses a problem in selection of suitable amplifiers. Hence, depending on the application, suitable configuration - either low-side or high-side current measurement technique has to be selected.

<fig-caption src="development/high_side_current_measurement.svg" caption="Principle of high-side current measurement" num="7" />

When higher supply voltages (>15V) are used, the circuit needs to be modified such that low voltage can be measured across the output, so that it can be integrated with other intermediate circuits or microcontroller. The modification depends mainly on the required output voltage range. An example of such circuit is shown below in the Fig. 8 where the output voltage has to be within 5V.

<fig-caption src="development/modified_high_side_measurement.svg" caption="Modified high-side current measurement for high voltages" num="8" />

Note that $V_{dd}$ has to be a few volts higher than $V_{CC}$

The differential amplifier is further connected to a NPN common collector amplifier to translate the measured voltage into corresponding current of required range. Further a PNP current mirror is used to branch this current into output branch. The mirrored current and chosen resistor at the output branch determines the output voltage range. Design steps for such circuit is given as below

1. Calculate the value of current $I_{R1}$, $I_{R2}$ and $I_{R4}$
2. Calculate the voltage at the node $V_{eQ1}$ (emitter of $Q_1$)
3. Determine the required value of resistor at output branch ($R_8$) and current ($I_{R8}$) such that approriate range of voltage is obtained at the output.
4. Calculate the value of current $I_{R5}$
5. Determine the value of resistor ($R_5$) required at the emitter of $Q_1$ to produce $I_{R5}$
6. Choose the value of resistors $R_6$ and $R_7$ to mirror the current $I_{R5}$ into the output branch. i.e, $R_6$ = $R_7$

## Dedicated ICs

The circuit for current measurement can be designed using individual discrete components according to the specific requirements, which provides great flexibility.

When the current sense amplifier has external gain setting resistors, problems like resistor matching and temperature dependency comes into picture. Dedicated ICs like [INA210](https://www.ti.com/product/INA210), integrate the external gain setting resistors and overcome the above issue, thereby providing better accuracy.

Choosing a suitable shunt resistor always comes with the trade-off between measurement accuracy and power dissipation. Choosing shunt with high resistance, increases the voltage developed across them. This increases the accuracy of measurement dramatically but also results in high power dissipation. Whereas, choosing a low value shunt will help reduce the problem of power dissipation, but leads to less accuracy. Apart from deciding the value of shunt resistor, the next challenge is a proper PCB layout for the shunt. Ignoring this often leads to error in measurement results. To overcome the challenge, dedicated ICs like [INA250](https://www.ti.com/product/INA250) can be used which integrate the shunt resistor into the IC and allow for an optimized PCB layout to achieve accurate measurement results.

Selection of suitable ADC is also important to obtain accurate measurements. The smallest possible voltage that can be measured by an ADC depends on its input voltage range and resolution. For example, an ADC with full scale input range($V_{in}$) of 2.5V and resolution($n$) of 12-bits, the smallest measurable voltage($V_{min}$) is approximately 610$\mu V$ (micro-volts).

$$V_{min} = \frac{V_{in}}{2^n}$$

There exist many ADCs designed specifically for bi-directional current measurement which have higher resolution and low voltage input range. This not only eliminates the need of amplifying the voltage drop across shunt, but also can measure really low voltages.

## Signal filtering

In current measurement, filtering of the signals may be required for various reasons. Signals can be filtered either at the input side or at the output side of the current sense amplifier.

When the current being measured is noisy, appropriate simple filters can be used at the output of current sense amplifier to get rid of noise. But, along with the input signal, noise will also be amplified by the amplifier. In this case, since low magnitude signals are being amplified, effect of noise can be significant. This also comes with the downside of loading down of the ADC.

Current sensing applications often have high amplitude and fast switching common-mode signals on the branch to which the shunt is connected, which may have frequent overshoot (spike). Along with this, in low value shunts, inductance becomes more significant which increases the amplitude of such spikes. The amplifier must be protected against these overshoots, even if spike frequencies are above the rated bandwidth of the device. Hence, appropriate filters are used at the input side of amplifier as shown in the Fig. 9.

<fig-caption src="development/input_filtering.svg" caption="Input side filtering of amplifier" num="9" />

The resistance of input resistors $R_5$ and $R_6$ and associated mismatch can adversely effect gain, common-mode rejection ratio ([CMRR](https://en.wikipedia.org/wiki/Common-mode_rejection_ratio)) and offset voltage of opamp. Hence, the value of these resistors have to be as low as possible (apprx 10$\Omega$). The capacitor has to be selected to perfectly match the time constant of shunt resistance and inductance. i.e, in general,

$$\frac{L_{shunt}}{R_{shunt}}\ \geq 2 \cdot R_{filt} \cdot C_{filt}$$

If the main purpose is to filter high frequency noise, the capacitor should be increased to a value that provides the desired filtering.

$$C_{filt} = \frac{1}{2 \cdot \pi \cdot f_{3db} \cdot (R_5 + R_6)}$$

Detailed explanation about filtering circuits for the amplifier can be obtained by corresponding device's datasheet. (e.g. [NCS210R](https://www.onsemi.com/pub/Collateral/NCS210R-D.PDF))
